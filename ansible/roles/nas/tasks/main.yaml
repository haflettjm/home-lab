---
# ==============================================================================
# NAS role - Podman container runtime and NFS server configuration
# Applied to nas group nodes (not part of K3s cluster)
# ==============================================================================

# ------------------------------------------------------------------------------
# Install Podman packages
# ------------------------------------------------------------------------------
- name: Install Podman and container tools
  ansible.builtin.dnf:
    name: "{{ nas_podman_packages }}"
    state: present
  become: true
  tags:
    - nas
    - podman
    - packages

# ------------------------------------------------------------------------------
# Enable Podman socket (for Docker API compatibility)
# ------------------------------------------------------------------------------
- name: Enable and start podman socket
  ansible.builtin.systemd:
    name: podman.socket
    state: started
    enabled: true
  become: true
  tags:
    - nas
    - podman

# ------------------------------------------------------------------------------
# Install NFS server packages
# ------------------------------------------------------------------------------
- name: Install NFS server packages
  ansible.builtin.dnf:
    name: "{{ nas_nfs_packages }}"
    state: present
  become: true
  tags:
    - nas
    - nfs
    - packages

# ------------------------------------------------------------------------------
# Create NFS export directory
# ------------------------------------------------------------------------------
- name: Create NFS export directory
  ansible.builtin.file:
    path: "{{ nfs_export_path }}"
    state: directory
    owner: nobody
    group: nobody
    mode: "0777"
  become: true
  tags:
    - nas
    - nfs

# ------------------------------------------------------------------------------
# Configure NFS exports
# ------------------------------------------------------------------------------
- name: Deploy NFS exports configuration
  ansible.builtin.template:
    src: exports.j2
    dest: /etc/exports
    owner: root
    group: root
    mode: "0644"
    backup: true
  become: true
  notify: Restart nfs-server
  tags:
    - nas
    - nfs

# ------------------------------------------------------------------------------
# Enable and start NFS services
# ------------------------------------------------------------------------------
- name: Enable and start rpcbind
  ansible.builtin.systemd:
    name: rpcbind
    state: started
    enabled: true
  become: true
  tags:
    - nas
    - nfs

- name: Enable and start nfs-server
  ansible.builtin.systemd:
    name: nfs-server
    state: started
    enabled: true
  become: true
  tags:
    - nas
    - nfs

- name: Export NFS shares
  ansible.builtin.command:
    cmd: exportfs -rav
  changed_when: false
  become: true
  tags:
    - nas
    - nfs

# ------------------------------------------------------------------------------
# Configure firewalld for NFS
# ------------------------------------------------------------------------------
- name: Open firewall services for NFS
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ nas_firewall_services }}"
  become: true
  tags:
    - nas
    - nfs
    - firewall
